# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Business Website Spec Generator built with Convex and React. It's an AI-powered chat application where users describe their business and receive a comprehensive, editable website specification document generated by GPT-4o-mini.

**Core Flow:**
1. User starts a conversation describing their business
2. AI generates a detailed website specification document
3. User can continue chatting to refine the spec
4. Spec updates in real-time in the document panel
5. User can manually edit and export the final specification

## Development Commands

### Running the Application
- `npm install` - Install all dependencies (required first-time setup)
- `npm run dev` - Start both frontend (Vite) and backend (Convex) in parallel
  - Frontend runs at: http://localhost:5173/
  - Convex dashboard: https://dashboard.convex.dev/d/keen-warbler-83
- `npm run dev:frontend` - Start only the Vite dev server
- `npm run dev:backend` - Start only Convex dev (connects to `CONVEX_DEPLOYMENT` in `.env.local`)

### Building and Validation
- `npm run build` - Build the frontend for production
- `npm run lint` - Run comprehensive lint check (TypeScript check for both Convex and frontend, Convex validation, and Vite build)

### Convex-Specific Commands
- `npx convex dev` - Connect to Convex dev environment
- `npx convex deploy` - Deploy backend to production

## Architecture

### Backend (Convex)

**Database Schema** (convex/schema.ts):
- `conversations` - Stores chat history with messages array
- `documents` - Website spec documents, one per conversation
- Auth tables from `@convex-dev/auth` for anonymous authentication

**Key Backend Files:**
- `convex/conversations.ts` - CRUD operations for conversations and messages
- `convex/documents.ts` - CRUD operations for specification documents
- `convex/ai.ts` - The core AI action that generates/updates specs using OpenAI
  - Uses GPT-4o-mini via bundled Convex OpenAI integration
  - Environment variables: `CONVEX_OPENAI_BASE_URL`, `CONVEX_OPENAI_API_KEY`
  - Has fallback mock data when OpenAI is unavailable
  - Detects if updating existing spec vs creating new one
- `convex/auth.ts` & `convex/auth.config.ts` - Anonymous auth via Convex Auth
- `convex/http.ts` & `convex/router.ts` - HTTP routing (auth routes in http.ts should not be modified)

**Important Pattern:** The AI action (`generateWebsiteSpec`) orchestrates the full flow:
1. Fetches conversation context
2. Checks for existing document
3. Generates appropriate prompt (create vs update)
4. Calls OpenAI API
5. Adds assistant message to conversation
6. Creates or updates the document

### Frontend (React + Vite)

**Component Architecture:**
- `src/App.tsx` - Main layout with header and authenticated/unauthenticated views
- `src/components/ChatPanel.tsx` - Left panel: conversation list + chat interface
- `src/components/DocumentPanel.tsx` - Right panel: editable document viewer
- Layout uses CSS Grid (50/50 split) with full-height viewport strategy

**State Management:**
- Uses Convex React hooks (`useQuery`, `useMutation`, `useAction`)
- Shared state: `selectedConversationId` flows from App → ChatPanel & DocumentPanel
- Real-time updates via Convex subscriptions

**Styling:**
- Tailwind CSS with custom theme in `tailwind.config.js`
- Custom colors: `primary` (#2563eb), `secondary` (#64748b)
- Global styles in `src/index.css` including full-height layout setup
- Auth-specific classes: `.auth-input-field`, `.auth-button` (only for auth forms)

### Full-Height Layout Strategy

**Critical for UI layout:** The app uses a specific pattern to fill the viewport:
```css
/* In src/index.css */
html, body, #root {
  height: 100%;
}
```
```jsx
/* In src/App.tsx */
<div className="h-full flex flex-col">  /* Not min-h-screen */
  <main className="flex-1 overflow-hidden">
    <Content />  /* Also uses h-full */
  </main>
</div>
```

This ensures ChatPanel and DocumentPanel take full viewport height without squashing to the top.

## Key Integration Points

### Convex + OpenAI Integration
The app uses Convex's built-in OpenAI integration (not a direct OpenAI client):
- API key stored as Convex environment variable
- Configured via `CONVEX_OPENAI_BASE_URL` and `CONVEX_OPENAI_API_KEY`
- Model: `gpt-4o-mini` with temperature 0.7, max_tokens 3000

### Document-Conversation Relationship
- One conversation → One document (1:1 relationship)
- Documents are linked via `conversationId`
- When user sends first message: creates conversation → generates spec → creates document
- Subsequent messages: updates existing document

## Authentication

Uses Convex Auth with anonymous authentication:
- No email/password required
- Users auto-authenticated on first visit
- All queries/mutations check `getAuthUserId(ctx)`
- Auth configuration in `convex/auth.config.ts`

## Environment Configuration

Required environment variables in `.env.local`:
- `CONVEX_DEPLOYMENT` - Convex deployment identifier (e.g., "dev:keen-warbler-83")
- `VITE_CONVEX_URL` - Convex cloud URL (e.g., "https://keen-warbler-83.convex.cloud")
- Backend also needs `CONVEX_OPENAI_BASE_URL` and `CONVEX_OPENAI_API_KEY` (set in Convex dashboard)

## Important Notes

- **Do not modify** `convex/http.ts` auth routes - user HTTP routes go in `convex/router.ts`
- The Vite config includes Chef-specific dev tooling for screenshot functionality during development
- TypeScript configurations are split: `tsconfig.json` (frontend) and `convex/tsconfig.json` (backend)
- Toaster notifications use `sonner` library for user feedback
